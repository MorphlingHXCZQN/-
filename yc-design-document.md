# 压疮风险因子寻找与时间序列数据集设计文档

> 目标：在 MIMIC-IV 3.0 数据上构建**时间序列**压疮风险数据集，完成**独立风险因子**识别与**风险预警模型**（非预测模型）建设。
> 
> 说明：以下内容为**设计层面**说明，聚焦时间序列构造方案、统计建模与预警流程的结构与原则，**不包含代码**。具体实现与最简代码请见技术路线文档。

---

## 1. 项目路径约定

- **MIMIC-IV 3.0 数据路径**：
  - `E:\迅雷下载\mimic-iv-3.0\mimic-iv-3.0`
- **所有结果输出路径**：
  - `C:\Users\huxia\Desktop\压疮项目风险因子寻找`

> 建议在 Python 中统一配置路径常量，并在所有脚本中引用该常量，以避免路径错配。

---

## 2. 压疮时间序列数据集构造（改进方案）

### 2.1 原则

1. **以 ICU stay 为单位**，避免跨 ICU stay 造成的信息泄漏。  
2. **将时间对齐到 ICU 入科时间**（`intime`），窗口按天/小时滚动。  
3. **明确“观察窗口”和“预测窗口”**：
   - 例如：用前 24 小时信息预测未来 24-48 小时是否发生压疮（严格时间分离）。
4. **严格排除事件发生后数据**（预防信息泄漏）。
5. **缺失机制显式化**（保留 `mask__` 特征并统一规则处理）。

### 2.2 数据集结构建议

| 字段 | 说明 |
|---|---|
| `subject_id` | 患者 ID |
| `hadm_id` | 入院 ID |
| `stay_id` | ICU stay ID |
| `day_index` | 第几天（0 起） |
| `window_start` / `window_end` | 观察窗口起止时间 |
| `y_future_24h` / `y_future_48h` | 未来窗口是否发生压疮 |
| `feature_*` | 处理后的特征 |
| `mask__*` | 缺失标记 |
| `dataset_split` | train/val/test |

### 2.3 关键时间逻辑建议

1. **事件时间（压疮发生时间）**：
   - 从 `diagnoses_icd` + `chartevents` + `nursing` 文本中提取。
   - 以“首次出现压疮记录”的时间作为事件时刻。

2. **窗口构造**：
   - 使用滑动窗口：
     - `window = [t, t+24h)`
     - `label = 1 if event_time in (t+24h, t+48h]`
   - 同时生成 `y_future_24h`、`y_future_48h` 以便比较不同风险窗口。

3. **排除策略**：
   - 若压疮已在 ICU 入科前或入科 24h 内已明确存在，标记为 `prevalent_before_pred=1` 并剔除出训练集。

---

## 3. 特征工程改进建议

### 3.1 静态特征

- 年龄、性别、BMI、入院来源、基础疾病（Charlson）、ICU 类型、SOFA/APACHE 等。

### 3.2 动态特征（时序）

1. **生命体征**：心率、血压、体温、呼吸、SpO2。  
2. **实验室检查**：白细胞、白蛋白、血糖、乳酸、血红蛋白。  
3. **护理评估**：Braden 评分等。
4. **治疗/干预**：镇静药、血管活性药、机械通气、体位翻身记录。

### 3.3 时间序列聚合规则

- 对同一窗口内多次记录：
  - **数值型**：mean / min / max / std（可选）
  - **布尔/事件型**：是否发生（max）
- 建议保留“趋势”特征：
  - 例如 `delta_hr_24h = mean(hr_last12h) - mean(hr_prev12h)`

### 3.4 缺失处理策略

你当前的脚本已包含：
- mask 特征固定为 0/1
- object 类型自动转为 bool/numeric/categorical

改进建议：
1. **数值型缺失保留为 0 + mask 标记**（不要均值填充）。
2. **类别型：train-only mapping**，未知为 0。
3. **对极高基数列**（ID/自由文本）直接丢弃。

---

## 4. 独立风险因子识别方案

### 4.1 统计学方案

- **单因素分析**：
  - 数值型：Mann-Whitney U / t-test
  - 分类型：卡方检验
- **多因素模型**：
  - Logistic 回归（加入 L1/L2 正则）
  - 可用 `statsmodels` 输出 OR、95% CI

### 4.2 变量选择与解释

> 说明：以可解释性为主，强调临床可理解的变量集合与稳定性。

---

## 5. 风险预警模型（非预测模型）

> 目标：提供风险分级/预警系统，强调**可解释性**与**临床可用性**，而不是单纯黑箱预测。

### 5.1 推荐模型

1. **Logistic 回归 + 风险评分**
   - 使用多因素模型的 OR 计算风险评分；
   - 将患者划分为低/中/高风险。

2. **解释性规则模型**
   - 结合临床指南 + 数据统计显著因子。

### 5.2 预警输出格式建议

| stay_id | day_index | risk_prob | risk_level | top_factors |
|---|---|---|---|---|
| 3001 | 2 | 0.42 | high | 低白蛋白、Braden 低、血红蛋白低 |

---

## 6. 技术路线文档说明

- 所有**代码实现**已移至技术路线文档：`yc-technical-roadmap.md`。
- 本文档仅保留设计、原则与数据结构建议。

---

## 7. 推荐工作流（设计层面）

1. **构建时序数据集**（window、label、mask）  
2. **数据清洗与类型统一**（你现有脚本）  
3. **独立风险因子筛选**（多因素 logistic）  
4. **构建风险评分模型**  
5. **生成风险预警输出**（临床可解释）

---

## 8. 质量控制与注意事项

- **防止信息泄漏**：
  - 所有特征必须来自预测窗口之前
- **缺失不是噪声**：
  - 缺失本身可能代表风险，务必保留 mask
- **严格区分“预测模型”与“预警模型”**：
  - 预警强调解释性和可控性

---

## 9. 下一步建议

1. 先完成 `modelready.csv` 时间序列构造脚本并验证时序逻辑。
2. 运行多因素回归得到显著因子。
3. 构建风险评分与分级标准。
4. 与临床专家确认风险阈值。

---

**文件名：** `yc-design-document.md`
